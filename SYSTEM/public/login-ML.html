<!DOCTYPE html>
<html lang="en">
<script src="script-ML.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:20px 30px; border-radius:8px; text-align:center; min-width:250px;">
        <p id="modalMessage"></p>
        <button id="modalOk" style="margin-top:15px; padding:5px 15px;">OK</button>
    </div>
    </div>
    <div class="formBox">
        <div class="formHeader">
            <h2> Log-in </h2>
        </div>
        <form id="mlForm" autocomplete="off">
            <div class="formInput">
                <p>Email</p>
                    <input type="email" name="email" required>
            </div>
            <div class="button">
                <button id="sButton" class="submit" type="submit">Submit</button>
            </div>
        </form>
    </div>

</body>
<script>
window.addEventListener("DOMContentLoaded", () => {

    const modal = document.getElementById('modal');
    const modalMessage = document.getElementById('modalMessage');
    const modalOk = document.getElementById('modalOk');
    const form = document.getElementById("mlForm");

    function showModal(message) {
        modalMessage.textContent = message;
        modal.style.display = 'flex';
    }

    modalOk.addEventListener('click', () => {
        modal.style.display = 'none';

        if (modalMessage.textContent === "Login successful") {
            window.location.href = "confirmationML.html";
        }
    });

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    if (token) {
        fetch(`/magic-login?token=${token}`)
            .then(res => res.json())
            .then(data => {
                showModal(data.message);

                if (data.success) {
                    window.history.replaceState({}, document.title, "/login-ML.html");
                }
            })
            .catch(() => showModal("Login failed"));
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault(); 

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch("/send-magic-link", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });

            const text = await res.text();
            showModal(text);

        } catch (err) {
            showModal("Failed to send email");
        }
    });

});
</script>


</html>