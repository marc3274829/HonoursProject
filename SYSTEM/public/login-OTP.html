<!DOCTYPE html>
<html lang="en">
<script src="script-ML.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:20px 30px; border-radius:8px; text-align:center; min-width:250px;">
      <p id="modalMessage"></p>
      <input type="text" id="otpInput" placeholder="Enter OTP" style="display:none; margin-top:10px; padding:5px;">
      <button id="modalOk" style="margin-top:15px; padding:5px 15px;">OK</button>
    </div>
    </div>
    <div class="formBox">
        <div class="formHeader">
            <h2> Log-in </h2>
        </div>
        <form id="otpForm" autocomplete="off">
            <div class="formInput">
                <p>Email</p>
                    <input type="text" name="email" required>
            </div>
            <div class="button">
                <button id="sButton" class="submit" type="submit">Submit</button>
            </div>
        </form>
    </div>

</body>
  <script>
    const emailForm = document.getElementById('otpForm');
    const modal = document.getElementById('modal');
    const modalMessage = document.getElementById('modalMessage');
    const modalOk = document.getElementById('modalOk');
    const otpInput = document.getElementById('otpInput');
    let currentEmail = "";

    function showModal(message, showOtp = false) {
      modalMessage.textContent = message;
      otpInput.style.display = showOtp ? 'block' : 'none';
      modal.style.display = 'flex';
    }

    modalOk.addEventListener('click', async () => {
    if (otpInput.style.display === 'block') {
        const otp = otpInput.value.trim();
        if (!otp) return;

        try {
        const res = await fetch('/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, otp })
        });
        const data = await res.json();
        showModal(data.message); 
        } catch (err) {
        showModal("Server error");
        }

    } else {
        modal.style.display = 'none';

        if (modalMessage.textContent === "OTP verified! Login successful.") {
        window.location.href = "confirmationOTP.html";
        }
    }
    });


    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailForm.email.value.trim();
      if (!email) return;

      currentEmail = email;

      try {
        const res = await fetch('/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        showModal(data.message, data.success);
      } catch (err) {
        showModal("Server error");
      }
    });
  </script>
</html>